<!--

  ❤️‍🔥 This script can be used to bulk update data in OSM.
  Can be run from file:// , doesn't need to be hosted somewhere.

  in its current state it won't work, but could be modified for
  other automated edits.

-->
<input type="text" placeholder="username" />
<input type="password" placeholder="password" />
<ul>
  Loading...
</ul>
<script>
  const MAP = {};

  /**
   * @param {string} oldName
   * @param {"suburb" | "hamlet"} type
   * @param {[[a: number, b: number], [c: number, d: number]]} bbox
   * @returns string - XML
   */
  async function fetchFromOverpass(oldName, type, bbox) {
    const weirdBbox = [bbox[0][1], bbox[0][0], bbox[1][1], bbox[1][0]];

    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`[out:xml][timeout:25];(
    node["addr:${type}"="${oldName}"](${weirdBbox.join(",")});
    way["addr:${type}"="${oldName}"](${weirdBbox.join(",")});
    relation["addr:${type}"="${oldName}"](${weirdBbox.join(
      ","
    )}); );out meta;>;out meta
    qt;`)}`;

    const d = await fetch(url).then((r) => r.text());

    return d;
  }

  const PLACEHOLDER = "__PUT_CS_ID_HERE__";

  /**
   * @param {string} newName
   * @param {string} osmChangeFile (XML)
   * @returns {Promise<string>} changeset ID
   */
  async function uploadChangeset(newName, osmChangeFile) {
    const username = document.querySelector("input[type=text]").value;
    const password = document.querySelector("input[type=password]").value;

    if (!username) throw new Error("No username!");
    if (!password) throw new Error("No password!");

    const BASE_URL = "https://www.openstreetmap.org";

    const r1 = await fetch(`${BASE_URL}/api/0.6/changeset/create`, {
      method: "PUT",
      body: `<osm>
    	<changeset>
    		<tag k="attribution" v="https://wiki.openstreetmap.org/wiki/Contributors#LINZ"/>
    		<tag k="created_by" v="LINZ Address Import 1.1.1"/>
    		<tag k="comment" v="Address Update - ${newName}"/>
    		<tag k="source" v="https://data.linz.govt.nz/layer/3353"/>
    	</changeset>
    	...
    </osm>`,
      headers: {
        "content-type": "application/xml; charset=utf-8",
        Authorization: `Basic ${btoa(`${username}:${password}`)}`,
      },
    });
    if (r1.status !== 200) throw new Error("Create CS failed");

    const csId = await r1.text();

    const r2 = await fetch(`${BASE_URL}/api/0.6/changeset/${csId}/upload`, {
      method: "POST",
      body: osmChangeFile.replace(new RegExp(PLACEHOLDER, "g"), csId),
      headers: {
        "content-type": "application/xml; charset=utf-8",
        Authorization: `Basic ${btoa(`${username}:${password}`)}`,
      },
    });
    if (r2.status !== 200) throw new Error("Upload CS payload failed");

    const r3 = await fetch(`${BASE_URL}/api/0.6/changeset/${csId}/close`, {
      method: "PUT",
      headers: {
        Authorization: `Basic ${btoa(`${username}:${password}`)}`,
      },
    });
    if (r3.status !== 200) throw new Error("Close CS failed");

    return csId;
  }

  /**
   * This is called from the HTML
   * @param {string} id - ID of the sector
   * @param {HTMLAnchorElement} el - ID of the sector
   */
  async function select(id, el) {
    try {
      const li = el.parentElement;
      li.innerHTML = el.innerHTML + " - LOADING...";

      const dataset = results.find((x) => x.id === id);

      const data = await fetch(dataset.url).then((r) => r.json());

      const { extent } = dataset;
      const type = data.features[0].properties.addr_hamlet
        ? "hamlet"
        : "suburb";
      const newName =
        data.features[0].properties.addr_hamlet ||
        data.features[0].properties.addr_suburb;
      const oldName = Object.entries(MAP).find(([, v]) => v === newName)[0];

      console.log({ type, newName, oldName, extent });

      const overpassData = await fetchFromOverpass(oldName, type, extent);

      const osmChangeFile = overpassData
        .replace(
          new RegExp(`<tag k="addr:${type}" v="${oldName}"/>`, "g"),
          `<tag k="addr:${type}" v="${newName}"/>`
        )
        .replace(
          /<node id="(.+)" lat="(.+)" lon="(.+)" version="(.+)" timestamp="(.+)" changeset="(.+)" uid="(.+)" user="(.+)">/g,
          (
            _,
            nId,
            lat,
            lng,
            OLDversion,
            OLDdate,
            OLDcsId,
            OLDuId,
            OLDuserName
          ) => {
            return `<node id="${nId}" lat="${lat}" lon="${lng}" version="${OLDversion}" changeset="${PLACEHOLDER}">`;
          }
        )
        // delete nodes with no tags, there is no point in updating them. probably the corners of a building with an address
        .replace(
          /<node id="(.+)" lat="(.+)" lon="(.+)" version="(.+)" timestamp="(.+)" changeset="(.+)" uid="(.+)" user="(.+)"\/>/g,
          ""
        )
        .replace(
          /<(way|relation) id="(.+)" version="(.+)" timestamp="(.+)" changeset="(.+)" uid="(.+)" user="(.+)">/g,
          (
            _,
            type, // way|relation
            nId,
            OLDversion,
            OLDdate,
            OLDcsId,
            OLDuId,
            OLDuserName
          ) => {
            return `<${type} id="${nId}" version="${OLDversion}" changeset="${PLACEHOLDER}">`;
          }
        )
        .replace(/<note>.+<\/note>/, "")
        .replace(/<meta osm_base=".+"\/>/, "")
        .replace(/<\/osm>/, "</modify></osmChange>")
        .replace(
          /<osm version="0.6" generator=".+">/,
          '<osmChange version="0.6" generator="LINZ Address Import"><modify>'
        );

      /* Download osmChange file */
      // const a = Object.assign(document.createElement("a"), {
      //   download: `${newName}.osmChange`,
      //   href: `data:text/plain,${newData}`,
      // });
      // document.body.appendChild(a);
      // a.click();
      // document.body.removeChild(a);

      const csId = await uploadChangeset(newName, osmChangeFile);
      li.innerHTML += ` - <a href='https://osm.org/changeset/${csId}'>DONE</a>`;
    } catch (ex) {
      console.error(ex);
      alert("Failed: " + ex);
    }
  }

  const index = "https://linz-addr-cdn.kyle.kiwi/index.json";
  async function main() {
    const { results } = await fetch(index).then((r) => r.json());
    window.results = results;

    document.querySelector("ul").innerHTML = results
      .sort((a, b) => a.totalCount - b.totalCount)
      .map((x) => {
        return `<li>${x.totalCount} <a href="#" onclick="select('${x.id}', this)">${x.name}</a></li>`;
      })
      .join("");
  }
  main();
</script>
